openapi: 3.0.3
info:
  title: FacturaFlow API
  description: |
    API para gestión de facturas CFDI v2.2.
    
    Esta API permite:
    - Registrar facturas con archivos XML/PDF
    - Validar si un UUID ya existe
    - Obtener lista de proyectos
    - Verificar el estado de los servicios
    - Autenticación de usuarios (flotilleros/drivers)
    - Gestión de API Keys para acceso programático
    - Panel administrativo con reportes y exportaciones
    
    **Novedades v2.2:**
    - Sistema de API Keys para acceso programático
    - Autenticación de usuarios (flotilleros/drivers) con password y magic link
    - Exportación de pagos en formato XLSX (Shinkansen/BBVA)
    - Configuración del sistema administrable
    - Información bancaria de flotilleros para dispersión de pagos
    
    **Novedades v2.0:**
    - Soporte para modelo Flotilleros/Drivers
    - Un flotillero puede tener múltiples drivers
    - Un driver independiente es un flotillero de tipo 'independiente'
    - Los archivos se almacenan automáticamente en Google Drive
  version: 2.2.0
  contact:
    name: PartRunner Support
    email: soporte@partrunner.com
    url: https://github.com/workofger/sube-tu-factura

servers:
  - url: https://sube-tu-factura.vercel.app/api
    description: Producción
  - url: http://localhost:3000/api
    description: Desarrollo local

tags:
  - name: Invoices
    description: Operaciones con facturas
  - name: Projects
    description: Catálogo de proyectos
  - name: Health
    description: Estado del sistema
  - name: User Auth
    description: Autenticación de usuarios (flotilleros/drivers)
  - name: Admin
    description: Panel administrativo
  - name: API Keys
    description: Gestión de API Keys

security:
  - BearerAuth: []
  - ApiKeyAuth: []

paths:
  # ========== Invoices ==========
  /invoice:
    post:
      tags:
        - Invoices
      summary: Registrar factura
      description: |
        Procesa y registra una factura CFDI completa con archivos.
        
        El proceso:
        1. Valida los datos de entrada
        2. Verifica que el UUID no exista (duplicado)
        3. Crea/actualiza el flotillero (facturador)
        4. Crea/actualiza el driver asociado
        5. Guarda la factura con relaciones
        6. Sube archivos a Google Drive
        7. Actualiza referencias de archivos en BD
      operationId: createInvoice
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InvoicePayload'
      responses:
        '201':
          description: Factura registrada exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InvoiceSuccessResponse'
        '400':
          description: Error de validación
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
        '409':
          description: Factura duplicada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DuplicateErrorResponse'
        '500':
          description: Error interno
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InternalErrorResponse'

  /validate:
    post:
      tags:
        - Invoices
      summary: Validar UUID
      description: Verifica si un UUID de factura ya existe en el sistema
      operationId: validateUuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - uuid
              properties:
                uuid:
                  type: string
                  format: uuid
                  example: "3FA85F64-5717-4562-B3FC-2C963F66AFA6"
      responses:
        '200':
          description: Resultado de validación
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidateResponse'
        '400':
          description: UUID inválido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'

  /extract:
    post:
      tags:
        - Invoices
      summary: Extraer datos de factura
      description: |
        Usa IA (OpenAI GPT-4o) para extraer datos de archivos XML/PDF de facturas CFDI.
        Retorna un objeto estructurado con todos los datos extraídos.
      operationId: extractInvoiceData
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                xmlContent:
                  type: string
                  description: Contenido del archivo XML
                pdfBase64:
                  type: string
                  description: PDF en Base64
                pdfFilename:
                  type: string
                  description: Nombre del archivo PDF
      responses:
        '200':
          description: Datos extraídos exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtractionResponse'
        '400':
          description: Error de validación
        '500':
          description: Error en la extracción

  # ========== Projects ==========
  /projects:
    get:
      tags:
        - Projects
      summary: Obtener proyectos
      description: Retorna la lista de proyectos activos ordenados por sort_order
      operationId: getProjects
      responses:
        '200':
          description: Lista de proyectos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProjectsResponse'
        '500':
          description: Error interno
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InternalErrorResponse'

  # ========== Health ==========
  /health:
    get:
      tags:
        - Health
      summary: Estado del sistema
      description: Verifica la conexión con Supabase y Google Drive
      operationId: getHealth
      responses:
        '200':
          description: Sistema saludable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        '207':
          description: Sistema degradado
        '503':
          description: Sistema no disponible

  # ========== User Auth ==========
  /user/login:
    post:
      tags:
        - User Auth
      summary: Iniciar sesión
      description: Autenticar usuario con email y contraseña
      operationId: userLogin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  format: password
      responses:
        '200':
          description: Login exitoso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserAuthResponse'
        '401':
          description: Credenciales inválidas
        '403':
          description: Cuenta no verificada o inactiva

  /user/register:
    post:
      tags:
        - User Auth
      summary: Registrar usuario
      description: Registrar nuevo flotillero/driver independiente
      operationId: userRegister
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
                - rfc
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  minLength: 8
                rfc:
                  type: string
                  pattern: '^[A-ZÑ&]{3,4}\d{6}[A-Z0-9]{3}$'
                full_name:
                  type: string
      responses:
        '201':
          description: Registro exitoso
        '400':
          description: Datos inválidos
        '409':
          description: Email o RFC ya registrado

  /user/magic-link:
    post:
      tags:
        - User Auth
      summary: Solicitar magic link
      description: Envía un enlace de acceso sin contraseña al email
      operationId: requestMagicLink
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
      responses:
        '200':
          description: Si el email existe, se enviará un enlace

  /user/verify-magic-link:
    get:
      tags:
        - User Auth
      summary: Verificar magic link
      description: Verifica el token del magic link y autentica al usuario
      operationId: verifyMagicLink
      parameters:
        - name: token
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Autenticación exitosa
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserAuthResponse'
        '401':
          description: Token inválido o expirado

  /user/profile:
    get:
      tags:
        - User Auth
      summary: Obtener perfil
      description: Obtiene el perfil del usuario autenticado
      operationId: getUserProfile
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Perfil del usuario
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '401':
          description: No autorizado
    put:
      tags:
        - User Auth
      summary: Actualizar perfil
      description: Actualiza datos del perfil (teléfono, dirección, datos bancarios)
      operationId: updateUserProfile
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                phone:
                  type: string
                address:
                  type: string
                bank_name:
                  type: string
                bank_clabe:
                  type: string
                  maxLength: 18
                  minLength: 18
      responses:
        '200':
          description: Perfil actualizado
        '400':
          description: Datos inválidos

  # ========== Admin ==========
  /admin/login:
    post:
      tags:
        - Admin
      summary: Login administrativo
      description: Autenticar usuario administrador
      operationId: adminLogin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
      responses:
        '200':
          description: Login exitoso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminAuthResponse'
        '401':
          description: Credenciales inválidas

  /admin/stats:
    get:
      tags:
        - Admin
      summary: Estadísticas del dashboard
      description: Obtiene estadísticas generales de facturas
      operationId: getAdminStats
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Estadísticas del sistema
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DashboardStats'

  /admin/invoices:
    get:
      tags:
        - Admin
      summary: Listar facturas
      description: Lista facturas con filtros y paginación
      operationId: getAdminInvoices
      security:
        - BearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: pageSize
          in: query
          schema:
            type: integer
            default: 20
        - name: week
          in: query
          schema:
            type: integer
        - name: year
          in: query
          schema:
            type: integer
        - name: project
          in: query
          schema:
            type: string
        - name: paymentProgram
          in: query
          schema:
            type: string
            enum: [standard, pronto_pago]
        - name: status
          in: query
          schema:
            type: string
        - name: search
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Lista de facturas

  /admin/export:
    get:
      tags:
        - Admin
      summary: Exportar facturas CSV
      description: Exporta facturas en formato CSV
      operationId: exportInvoicesCSV
      security:
        - BearerAuth: []
      parameters:
        - name: weekFrom
          in: query
          required: true
          schema:
            type: integer
        - name: weekTo
          in: query
          required: true
          schema:
            type: integer
        - name: year
          in: query
          required: true
          schema:
            type: integer
        - name: project
          in: query
          schema:
            type: string
        - name: paymentProgram
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Archivo CSV
          content:
            text/csv:
              schema:
                type: string

  /admin/export-payments:
    get:
      tags:
        - Admin
      summary: Exportar pagos XLSX
      description: |
        Exporta archivo de pagos en formato XLSX compatible con Shinkansen/BBVA.
        Agrupa facturas por flotillero y suma los montos netos a pagar.
      operationId: exportPaymentsXLSX
      security:
        - BearerAuth: []
      parameters:
        - name: week
          in: query
          required: true
          schema:
            type: integer
        - name: year
          in: query
          required: true
          schema:
            type: integer
        - name: project
          in: query
          schema:
            type: string
        - name: status
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Archivo XLSX
          content:
            application/vnd.openxmlformats-officedocument.spreadsheetml.sheet:
              schema:
                type: string
                format: binary

  /admin/config:
    get:
      tags:
        - Admin
      summary: Obtener configuración
      description: Obtiene configuraciones del sistema
      operationId: getSystemConfig
      security:
        - BearerAuth: []
      parameters:
        - name: key
          in: query
          schema:
            type: string
        - name: category
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Configuración del sistema
    put:
      tags:
        - Admin
      summary: Actualizar configuración
      description: Actualiza una configuración (solo super_admin)
      operationId: updateSystemConfig
      security:
        - BearerAuth: []
      parameters:
        - name: key
          in: query
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - value
              properties:
                value:
                  type: object
                description:
                  type: string
      responses:
        '200':
          description: Configuración actualizada
        '403':
          description: No autorizado

  # ========== API Keys ==========
  /admin/api-keys:
    get:
      tags:
        - API Keys
      summary: Listar API Keys
      description: Lista todas las API Keys (solo prefijo visible)
      operationId: listApiKeys
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Lista de API Keys
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/ApiKeyInfo'
    post:
      tags:
        - API Keys
      summary: Crear API Key
      description: |
        Crea una nueva API Key. 
        **IMPORTANTE:** La key completa solo se muestra una vez en la respuesta.
      operationId: createApiKey
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                description:
                  type: string
                scopes:
                  type: array
                  items:
                    type: string
                    enum: [public, admin, export, user]
                  default: [public, admin]
                rate_limit_per_minute:
                  type: integer
                  default: 60
                rate_limit_per_day:
                  type: integer
                  default: 10000
                expires_in_days:
                  type: integer
      responses:
        '201':
          description: API Key creada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateApiKeyResponse'
    delete:
      tags:
        - API Keys
      summary: Revocar API Key
      description: Revoca una API Key existente
      operationId: revokeApiKey
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: API Key revocada
        '404':
          description: API Key no encontrada

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Token JWT obtenido del login
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API Key para acceso programático (formato pk_xxxxx)

  schemas:
    InvoicePayload:
      type: object
      required:
        - week
        - project
        - issuer
        - receiver
        - invoice
        - payment
        - financial
        - items
        - files
      properties:
        week:
          type: integer
          minimum: 1
          maximum: 53
        project:
          type: string
        paymentProgram:
          type: object
          properties:
            program:
              type: string
              enum: [standard, pronto_pago]
            feeRate:
              type: number
            feeAmount:
              type: number
            netAmount:
              type: number
        issuer:
          $ref: '#/components/schemas/IssuerData'
        receiver:
          $ref: '#/components/schemas/ReceiverData'
        invoice:
          $ref: '#/components/schemas/InvoiceIdentification'
        payment:
          $ref: '#/components/schemas/PaymentData'
        financial:
          $ref: '#/components/schemas/FinancialData'
        items:
          type: array
          items:
            $ref: '#/components/schemas/InvoiceItem'
        contact:
          $ref: '#/components/schemas/ContactData'
        files:
          $ref: '#/components/schemas/FilesData'

    IssuerData:
      type: object
      required:
        - rfc
        - name
      properties:
        rfc:
          type: string
          pattern: '^[A-ZÑ&]{3,4}\d{6}[A-Z0-9]{3}$'
        name:
          type: string
        regime:
          type: string
        zipCode:
          type: string

    ReceiverData:
      type: object
      required:
        - rfc
      properties:
        rfc:
          type: string
        name:
          type: string
        regime:
          type: string
        zipCode:
          type: string
        cfdiUse:
          type: string

    InvoiceIdentification:
      type: object
      required:
        - uuid
        - date
      properties:
        uuid:
          type: string
          format: uuid
        folio:
          type: string
        series:
          type: string
        date:
          type: string
          format: date

    PaymentData:
      type: object
      required:
        - method
      properties:
        method:
          type: string
          enum: [PUE, PPD]
        form:
          type: string

    FinancialData:
      type: object
      required:
        - totalAmount
        - currency
      properties:
        subtotal:
          type: number
        totalTax:
          type: number
        retentionIva:
          type: number
        retentionIsr:
          type: number
        totalAmount:
          type: number
        currency:
          type: string
          default: MXN

    InvoiceItem:
      type: object
      required:
        - description
        - quantity
        - unitPrice
        - amount
      properties:
        description:
          type: string
        quantity:
          type: number
        unit:
          type: string
        unitPrice:
          type: number
        amount:
          type: number

    ContactData:
      type: object
      properties:
        email:
          type: string
          format: email
        phone:
          type: string

    FilesData:
      type: object
      properties:
        xml:
          $ref: '#/components/schemas/FileData'
        pdf:
          $ref: '#/components/schemas/FileData'

    FileData:
      type: object
      properties:
        name:
          type: string
        content:
          type: string
          format: byte
        mimeType:
          type: string

    InvoiceSuccessResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        data:
          type: object
          properties:
            invoiceId:
              type: string
              format: uuid
            uuid:
              type: string
            billerId:
              type: string
              format: uuid
            driverId:
              type: string
              format: uuid
            driveFolderPath:
              type: string
            files:
              type: object

    ValidationErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
        message:
          type: string
        details:
          type: array
          items:
            type: string

    DuplicateErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          example: "DUPLICATE_INVOICE"
        message:
          type: string
        data:
          type: object

    InternalErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
        message:
          type: string

    ValidateResponse:
      type: object
      properties:
        exists:
          type: boolean
        message:
          type: string
        existingInvoiceId:
          type: string
          format: uuid

    ProjectsResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: array
          items:
            $ref: '#/components/schemas/Project'

    Project:
      type: object
      properties:
        id:
          type: string
          format: uuid
        code:
          type: string
        name:
          type: string
        color:
          type: string
        is_active:
          type: boolean

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
        timestamp:
          type: string
          format: date-time
        services:
          type: object

    ExtractionResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        data:
          type: object
          description: Datos extraídos de la factura

    UserAuthResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        data:
          type: object
          properties:
            user:
              type: object
              properties:
                id:
                  type: string
                rfc:
                  type: string
                fiscal_name:
                  type: string
                email:
                  type: string
                type:
                  type: string
            token:
              type: string

    UserProfile:
      type: object
      properties:
        id:
          type: string
        rfc:
          type: string
        fiscal_name:
          type: string
        email:
          type: string
        phone:
          type: string
        type:
          type: string
          enum: [flotillero, independiente]
        bank_name:
          type: string
        bank_clabe:
          type: string
        stats:
          type: object
          properties:
            drivers_count:
              type: integer
            invoices_total:
              type: integer
            invoices_paid:
              type: integer
            total_facturado:
              type: number

    AdminAuthResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        data:
          type: object
          properties:
            token:
              type: string
            admin:
              type: object
              properties:
                id:
                  type: string
                email:
                  type: string
                fullName:
                  type: string
                role:
                  type: string
                  enum: [super_admin, finance, operations, viewer]

    DashboardStats:
      type: object
      properties:
        totalInvoices:
          type: integer
        totalAmount:
          type: number
        totalProntoPago:
          type: integer
        prontoPagoAmount:
          type: number
        totalStandard:
          type: integer
        standardAmount:
          type: number
        prontoPagoFees:
          type: number

    ApiKeyInfo:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        key_prefix:
          type: string
          description: Primeros 12 caracteres del key (pk_xxxxxxxx)
        scopes:
          type: array
          items:
            type: string
        rate_limit_per_minute:
          type: integer
        rate_limit_per_day:
          type: integer
        is_active:
          type: boolean
        status:
          type: string
          enum: [active, expired, revoked]
        created_at:
          type: string
          format: date-time
        last_used_at:
          type: string
          format: date-time
        total_requests:
          type: integer
        expires_at:
          type: string
          format: date-time

    CreateApiKeyResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        data:
          type: object
          properties:
            id:
              type: string
              format: uuid
            name:
              type: string
            key:
              type: string
              description: La API key completa - SOLO SE MUESTRA UNA VEZ
            prefix:
              type: string
            scopes:
              type: array
              items:
                type: string
            expires_at:
              type: string
              format: date-time
