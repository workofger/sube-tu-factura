# FacturaFlow AI - Cursor Rules

## Project Overview

FacturaFlow AI is a web application for processing Mexican CFDI invoices (Comprobante Fiscal Digital por Internet). It uses AI to extract data from XML/PDF files, stores them in Supabase, and organizes files in Google Drive.

## Tech Stack

### Frontend (src/)
- **React 18** + TypeScript
- **React Router DOM** for routing
- **Vite** for bundling
- **Tailwind CSS** for styling
- **Lucide React** for icons
- **date-fns** for date formatting

### Backend (api/)
- **Vercel Serverless Functions** (Node.js 20)
- **Supabase** (PostgreSQL) for database
- **Supabase Auth** for admin authentication
- **Google Drive API** for file storage
- **OpenAI GPT-4o** for invoice data extraction (server-side)

## Project Structure

\`\`\`
sube-tu-factura/
â”œâ”€â”€ api/                    # Vercel Serverless Functions
â”‚   â”œâ”€â”€ extract.ts         # POST /api/extract - AI extraction (OpenAI)
â”‚   â”œâ”€â”€ health.ts          # GET /api/health - Service health check
â”‚   â”œâ”€â”€ invoice.ts         # POST /api/invoice - Process invoice
â”‚   â”œâ”€â”€ projects.ts        # GET /api/projects - Get projects list
â”‚   â”œâ”€â”€ validate.ts        # POST /api/validate - Check UUID exists
â”‚   â””â”€â”€ lib/
â”‚       â”œâ”€â”€ supabase.ts    # Supabase client + DB operations
â”‚       â”œâ”€â”€ googleDrive.ts # Google Drive client + file ops
â”‚       â”œâ”€â”€ validators.ts  # Input validation functions
â”‚       â”œâ”€â”€ rateLimit.ts   # Rate limiting middleware
â”‚       â””â”€â”€ types.ts       # TypeScript interfaces
â”‚
â”œâ”€â”€ src/                    # React Frontend
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ admin/         # Admin: AdminLayout, ProtectedRoute
â”‚   â”‚   â”œâ”€â”€ common/        # Reusable: FileUpload, InputField, SelectField, AlertPopup
â”‚   â”‚   â”œâ”€â”€ layout/        # Header, WhatsAppButton
â”‚   â”‚   â””â”€â”€ sections/      # Form sections: Fiscal, Payment, Items, PaymentProgramSelector
â”‚   â”œâ”€â”€ contexts/
â”‚   â”‚   â””â”€â”€ AdminAuthContext.tsx  # Admin authentication context
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ useInvoiceForm.ts      # Form state management
â”‚   â”‚   â”œâ”€â”€ useInvoiceExtraction.ts # AI extraction logic
â”‚   â”‚   â”œâ”€â”€ useProjects.ts         # Fetch projects from API
â”‚   â”‚   â”œâ”€â”€ useWeekOptions.ts      # Week selector options
â”‚   â”‚   â””â”€â”€ useAdminAuth.ts        # Admin authentication hook
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â””â”€â”€ supabaseClient.ts      # Supabase client for frontend
â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â”œâ”€â”€ Upload.tsx             # Main invoice upload page
â”‚   â”‚   â””â”€â”€ admin/                 # Admin panel pages
â”‚   â”‚       â”œâ”€â”€ Login.tsx          # Admin login
â”‚   â”‚       â”œâ”€â”€ Dashboard.tsx      # Admin dashboard
â”‚   â”‚       â”œâ”€â”€ Invoices.tsx       # Invoice list with filters
â”‚   â”‚       â””â”€â”€ Reports.tsx        # Export CSV/PDF reports
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ openaiService.ts   # Calls backend /api/extract endpoint
â”‚   â”‚   â””â”€â”€ webhookService.ts  # Backend API communication
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â””â”€â”€ invoice.ts     # Invoice data types + PaymentProgram
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ dates.ts       # Date utilities
â”‚       â”œâ”€â”€ files.ts       # File handling (Base64, etc)
â”‚       â”œâ”€â”€ formatters.ts  # Number/string formatters
â”‚       â”œâ”€â”€ weekValidation.ts # Week validation logic
â”‚       â””â”€â”€ xmlParser.ts   # XML parsing utilities
â”‚
â”œâ”€â”€ database/               # SQL migrations
â”‚   â”œâ”€â”€ 001_initial_schema.sql
â”‚   â”œâ”€â”€ 002_add_flotilleros.sql
â”‚   â”œâ”€â”€ 003_add_pronto_pago.sql    # Pronto Pago feature
â”‚   â”œâ”€â”€ 004_add_admin_users.sql    # Admin panel users
â”‚   â””â”€â”€ schema.md          # Full DB documentation
â”‚
â””â”€â”€ docs/api/              # API documentation
    â”œâ”€â”€ README.md
    â”œâ”€â”€ SETUP.md
    â”œâ”€â”€ openapi.yaml
    â””â”€â”€ postman.json
\`\`\`

## Routes

| Route | Description |
|-------|-------------|
| / | Main invoice upload page (public) |
| /admin/login | Admin login page |
| /admin/dashboard | Admin dashboard with stats |
| /admin/invoices | Invoice list with filters |
| /admin/reports | Export CSV/PDF reports |

## Features

### Pronto Pago
Users can choose between:
- **Standard Payment**: Payment scheduled for next week (100% of total)
- **Pronto Pago**: Immediate payment (92% of total, 8% financial cost)

Database fields:
- payment_program: 'standard' | 'pronto_pago'
- pronto_pago_fee_rate: 0.08 (8%)
- pronto_pago_fee_amount: calculated fee
- net_payment_amount: total - fee
- scheduled_payment_date: calculated date

### Admin Panel
- Protected routes with Supabase Auth
- Role-based access (super_admin, finance, operations, viewer)
- Dashboard with invoice statistics
- Invoice list with filters and search
- Export reports to CSV and PDF

## Environment Variables

### Backend (server-side only - Vercel)
\`\`\`
OPENAI_API_KEY=sk-...
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_SERVICE_ROLE_KEY=eyJ...
GOOGLE_SERVICE_ACCOUNT_EMAIL=xxx@project.iam.gserviceaccount.com
GOOGLE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n..."
GOOGLE_DRIVE_ROOT_FOLDER_ID=1AbCd...
EXPECTED_RECEIVER_RFC=BLI180227F23
\`\`\`

### Frontend (VITE_ prefix)
\`\`\`
VITE_SUPABASE_URL=https://xxx.supabase.co
VITE_SUPABASE_ANON_KEY=eyJ...
\`\`\`

## Code Conventions

### TypeScript
- Use explicit types, avoid \`any\`
- Interfaces in \`/types/\` or \`/lib/types.ts\`
- Use \`.js\` extension in API imports (ES modules)

### React Components
- Functional components with hooks
- Props interfaces defined inline or in types/
- Use Tailwind for styling (no CSS files)
- Use AlertPopup component instead of window.alert()

### API Functions
- Export default handler function
- Always set CORS headers
- Return consistent format: \`{ success, message, data?, error?, details? }\`

### Error Handling
- Wrap async operations in try/catch
- Log with emoji prefixes: ğŸ“‹ (info), âœ… (success), âŒ (error), âš ï¸ (warning)
- Return user-friendly error messages in Spanish

## Known Patterns

### Preventing Extraction Loops
The \`useInvoiceExtraction\` hook uses \`extractionAttemptedRef\` to track file pairs that have been processed, preventing infinite loops when validation fails.

### File Processing Flow
1. User uploads XML + PDF
2. Frontend validates filenames match
3. Frontend extracts UUID from XML
4. Frontend calls \`/api/validate\` to check for duplicates
5. Frontend calls \`/api/extract\` for AI extraction
6. User selects payment program (Standard or Pronto Pago)
7. User reviews and confirms data
8. Frontend calls \`/api/invoice\` to save
