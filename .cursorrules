# FacturaFlow AI - Cursor Rules

## Project Overview

FacturaFlow AI is a web application for processing Mexican CFDI invoices (Comprobante Fiscal Digital por Internet). It uses AI to extract data from XML/PDF files, stores them in Supabase, and organizes files in Google Drive.

## Tech Stack

### Frontend (src/)
- **React 18** + TypeScript
- **Vite** for bundling
- **Tailwind CSS** for styling
- **Lucide React** for icons

### Backend (api/)
- **Vercel Serverless Functions** (Node.js 20)
- **Supabase** (PostgreSQL) for database
- **Google Drive API** for file storage
- **OpenAI GPT-4o** for invoice data extraction (server-side)

## Project Structure

\`\`\`
sube-tu-factura/
â”œâ”€â”€ api/                    # Vercel Serverless Functions
â”‚   â”œâ”€â”€ extract.ts         # POST /api/extract - AI extraction (OpenAI + project matching)
â”‚   â”œâ”€â”€ health.ts          # GET /api/health - Service health check
â”‚   â”œâ”€â”€ invoice.ts         # POST /api/invoice - Process invoice (with late invoice support)
â”‚   â”œâ”€â”€ projects.ts        # GET /api/projects - Get projects list
â”‚   â”œâ”€â”€ validate.ts        # POST /api/validate - Check UUID exists
â”‚   â”œâ”€â”€ admin/
â”‚   â”‚   â”œâ”€â”€ login.ts       # POST /api/admin/login
â”‚   â”‚   â”œâ”€â”€ invoices.ts    # GET /api/admin/invoices (with needsReview filter)
â”‚   â”‚   â”œâ”€â”€ projects.ts    # CRUD /api/admin/projects
â”‚   â”‚   â”œâ”€â”€ api-keys.ts    # API key management
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ user/              # User auth endpoints
â”‚   â””â”€â”€ lib/
â”‚       â”œâ”€â”€ supabase.ts    # Supabase client + DB operations
â”‚       â”œâ”€â”€ googleDrive.ts # Google Drive (with Extemporaneas folder)
â”‚       â”œâ”€â”€ storage.ts     # Supabase Storage
â”‚       â”œâ”€â”€ validators.ts  # Input validation functions
â”‚       â””â”€â”€ types.ts       # TypeScript interfaces
â”‚
â”œâ”€â”€ src/                    # React Frontend
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ common/        # FileUpload, InputField, AlertPopup, LateInvoiceModal
â”‚   â”‚   â”œâ”€â”€ layout/        # Header, WhatsAppButton
â”‚   â”‚   â”œâ”€â”€ sections/      # Form sections: Fiscal, Payment, Items
â”‚   â”‚   â””â”€â”€ admin/         # AdminLayout, ProtectedRoute
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ useInvoiceForm.ts      # Form state + late invoice handling
â”‚   â”‚   â”œâ”€â”€ useInvoiceExtraction.ts # AI extraction logic
â”‚   â”‚   â””â”€â”€ useAdminAuth.ts        # Admin authentication
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ openaiService.ts   # Calls backend /api/extract endpoint
â”‚   â”‚   â”œâ”€â”€ webhookService.ts  # Backend API communication
â”‚   â”‚   â””â”€â”€ adminService.ts    # Admin API service
â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â”œâ”€â”€ Upload.tsx     # Main upload page (auto week calculation)
â”‚   â”‚   â””â”€â”€ admin/         # Admin panel pages (incl. Projects.tsx)
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â””â”€â”€ invoice.ts     # Invoice data types (with late invoice fields)
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ dates.ts       # Date utilities (Mexico timezone, deadline logic)
â”‚       â””â”€â”€ xmlParser.ts   # XML parsing utilities
â”‚
â”œâ”€â”€ database/               # SQL migrations
â”‚   â”œâ”€â”€ 001_initial_schema.sql
â”‚   â”œâ”€â”€ ...
â”‚   â”œâ”€â”€ 011_add_late_invoice_fields.sql  # Late invoice + project keywords
â”‚   â””â”€â”€ schema.md
â”‚
â””â”€â”€ docs/api/
    â””â”€â”€ README.md
\`\`\`

## Business Logic

### Invoice Deadline (Fecha lÃ­mite)
- **Deadline**: Jueves 10:00 AM hora Ciudad de MÃ©xico (America/Mexico_City)
- **Valid invoices**: Invoice date must be Mon-Sun of the previous week
- **Late invoices (ExtemporÃ¡neas)**:
  - Uploaded after Thursday 10am â†’ \`late_reason: 'after_deadline'\`
  - Invoice date outside valid range â†’ \`late_reason: 'wrong_week'\`
- **Late invoice handling**:
  - Show confirmation popup (LateInvoiceModal)
  - Store in "Extemporaneas" folder in Drive
  - Schedule for next payment cycle

### Project Matching (AI)
- OpenAI analyzes invoice concepts and issuer name
- Uses project keywords and ai_description for context
- Returns \`project\` and \`projectConfidence\` (0.0-1.0)
- If confidence < 0.7 or project = "OTRO": \`needs_project_review = true\`

### Payment Programs
- **Standard**: Payment Friday of next week
- **Pronto Pago**: Payment same week, 8% fee deducted

## Google Drive Structure

\`\`\`
ðŸ“ Root Folder/
â”œâ”€â”€ ðŸ“ Semana_01_2026/
â”‚   â”œâ”€â”€ ðŸ“ MERCADO_LIBRE/
â”‚   â”‚   â””â”€â”€ ðŸ“ RFC_Name/
â”‚   â”‚       â””â”€â”€ uuid.xml, uuid.pdf
â”‚   â””â”€â”€ ðŸ“ Extemporaneas/       # Late invoices
â”‚       â””â”€â”€ ðŸ“ MERCADO_LIBRE/
â”‚           â””â”€â”€ ðŸ“ RFC_Name/
\`\`\`

## Code Conventions

### TypeScript
- Use explicit types, avoid \`any\`
- Use \`.js\` extension in API imports (ES modules)

### React Components
- Functional components with hooks
- Use Tailwind for styling (no CSS files)
- Use AlertPopup instead of window.alert()

### API Functions
- Export default handler function
- Always set CORS headers
- Return: \`{ success, message, data?, error?, details? }\`

## Important Notes

- **ES Modules**: API imports MUST use \`.js\` extensions
- **Timezone**: All deadlines use America/Mexico_City
- **Security**: OpenAI calls from backend only
- **Spanish UI**: User-facing text in Spanish
- **Week Selection**: Removed - calculated automatically from invoice date
