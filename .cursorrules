# FacturaFlow AI - Cursor Rules

## Project Overview

FacturaFlow AI is a web application for processing Mexican CFDI invoices (Comprobante Fiscal Digital por Internet). It uses AI to extract data from XML/PDF files, stores them in Supabase, and organizes files in Google Drive.

## Tech Stack

### Frontend (src/)
- **React 18** + TypeScript
- **Vite** for bundling
- **Tailwind CSS** for styling
- **Lucide React** for icons

### Backend (api/)
- **Vercel Serverless Functions** (Node.js 20)
- **Supabase** (PostgreSQL) for database
- **Google Drive API** for file storage
- **OpenAI GPT-4o** for invoice data extraction (server-side)

## Project Structure

```
sube-tu-factura/
â”œâ”€â”€ api/                    # Vercel Serverless Functions
â”‚   â”œâ”€â”€ extract.ts         # POST /api/extract - AI extraction (OpenAI)
â”‚   â”œâ”€â”€ health.ts          # GET /api/health - Service health check
â”‚   â”œâ”€â”€ invoice.ts         # POST /api/invoice - Process invoice
â”‚   â”œâ”€â”€ projects.ts        # GET /api/projects - Get projects list
â”‚   â”œâ”€â”€ validate.ts        # POST /api/validate - Check UUID exists
â”‚   â””â”€â”€ lib/
â”‚       â”œâ”€â”€ supabase.ts    # Supabase client + DB operations
â”‚       â”œâ”€â”€ googleDrive.ts # Google Drive client + file ops
â”‚       â”œâ”€â”€ validators.ts  # Input validation functions
â”‚       â””â”€â”€ types.ts       # TypeScript interfaces
â”‚
â”œâ”€â”€ src/                    # React Frontend
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ common/        # Reusable: FileUpload, InputField, SelectField, AlertPopup
â”‚   â”‚   â”œâ”€â”€ layout/        # Header, WhatsAppButton
â”‚   â”‚   â””â”€â”€ sections/      # Form sections: Fiscal, Payment, Items
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ useInvoiceForm.ts      # Form state management
â”‚   â”‚   â”œâ”€â”€ useInvoiceExtraction.ts # AI extraction logic (calls /api/extract)
â”‚   â”‚   â”œâ”€â”€ useProjects.ts         # Fetch projects from API
â”‚   â”‚   â””â”€â”€ useWeekOptions.ts      # Week selector options
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ openaiService.ts   # Calls backend /api/extract endpoint
â”‚   â”‚   â””â”€â”€ webhookService.ts  # Backend API communication
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â””â”€â”€ invoice.ts     # Invoice data types
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ dates.ts       # Date utilities
â”‚       â”œâ”€â”€ files.ts       # File handling (Base64, etc)
â”‚       â”œâ”€â”€ formatters.ts  # Number/string formatters
â”‚       â”œâ”€â”€ weekValidation.ts # Week validation logic
â”‚       â””â”€â”€ xmlParser.ts   # XML parsing utilities
â”‚
â”œâ”€â”€ database/               # SQL migrations
â”‚   â”œâ”€â”€ 001_initial_schema.sql
â”‚   â”œâ”€â”€ 002_add_flotilleros.sql
â”‚   â””â”€â”€ schema.md          # Full DB documentation
â”‚
â””â”€â”€ docs/api/              # API documentation
    â”œâ”€â”€ README.md
    â”œâ”€â”€ SETUP.md
    â”œâ”€â”€ openapi.yaml
    â””â”€â”€ postman.json
```

## Data Model

### Key Entities

1. **flotilleros** - Invoice issuers (fleet owners or independent drivers)
   - Can be type 'flotillero' (has multiple drivers) or 'independiente'
   
2. **drivers** - Delivery operators
   - Can belong to a flotillero (flotillero_id) or be independent
   
3. **invoices** - CFDI invoice records
   - biller_id: Who issued the invoice (flotillero)
   - operated_by_driver_id: Who did the work (optional)
   
4. **projects** - Client projects (Mercado Libre, Amazon, etc.)

### Relationships
```
flotilleros 1:N drivers
flotilleros 1:N invoices (as biller)
drivers N:1 invoices
projects 1:N invoices
```

## Environment Variables

### Backend (server-side only - Vercel Environment Variables)
```
OPENAI_API_KEY=sk-...              # OpenAI API key (NEVER expose in frontend)
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_SERVICE_ROLE_KEY=eyJ...
GOOGLE_SERVICE_ACCOUNT_EMAIL=xxx@project.iam.gserviceaccount.com
GOOGLE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n..."
GOOGLE_DRIVE_ROOT_FOLDER_ID=1AbCd...
EXPECTED_RECEIVER_RFC=BLI180227F23
```

> **IMPORTANT**: No API keys should be exposed in the frontend. All sensitive operations go through backend API endpoints.

## API Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | /api/extract | Extract invoice data using OpenAI (server-side) |
| POST | /api/invoice | Process and save complete invoice |
| POST | /api/validate | Check if UUID already exists |
| GET | /api/projects | Get list of active projects |
| GET | /api/health | Check service health (Supabase, Drive) |

## Code Conventions

### TypeScript
- Use explicit types, avoid `any`
- Interfaces in `/types/` or `/lib/types.ts`
- Use `.js` extension in API imports (ES modules requirement)

### React Components
- Functional components with hooks
- Props interfaces defined inline or in types/
- Use Tailwind for styling (no CSS files)
- Use AlertPopup component instead of window.alert()

### API Functions
- Export default handler function
- Always set CORS headers
- Return consistent response format: `{ success, message, data?, error?, details? }`

### Error Handling
- Wrap async operations in try/catch
- Log errors with console.error using emoji prefixes: ğŸ“‹ (info), âœ… (success), âŒ (error), âš ï¸ (warning)
- Return user-friendly error messages in Spanish

## Google Drive Structure

Files are organized in a 3-level hierarchy:
```
ğŸ“ Root Folder/
â”œâ”€â”€ ğŸ“ Semana_01_2026/           # Week folder
â”‚   â”œâ”€â”€ ğŸ“ MERCADO_LIBRE/        # Project folder
â”‚   â”‚   â””â”€â”€ ğŸ“ RFC_Name/         # Issuer folder
â”‚   â”‚       â”œâ”€â”€ uuid.xml
â”‚   â”‚       â””â”€â”€ uuid.pdf
```

## Common Tasks

### Adding a new API endpoint
1. Create `api/endpoint.ts`
2. Import with `.js` extension
3. Add CORS headers
4. Document in `docs/api/openapi.yaml`

### Adding a new form field
1. Update `types/invoice.ts` with new field
2. Add to form state in `useInvoiceForm.ts`
3. Add extraction in backend `api/extract.ts` prompt
4. Add input in appropriate section component

### Modifying the database
1. Create new migration in `database/`
2. Update `database/schema.md`
3. Update `api/lib/types.ts`
4. Update `api/lib/supabase.ts` functions

## Important Notes

- **ES Modules**: The project uses ES modules. API imports MUST use `.js` extensions.
- **Vercel Functions**: Each file in `api/` becomes a serverless function.
- **No SSR**: This is a client-side React app with API routes.
- **Spanish UI**: User-facing text should be in Spanish.
- **Mexican Invoices**: Focus on CFDI 4.0 format specifics.
- **Security**: OpenAI API calls are made from the backend only. Never expose API keys in frontend code.

## Validations

The system validates:
1. **Client-side (UX)**: File names match, basic field presence
2. **Server-side (Security)**: 
   - RFC format and expected receiver RFC
   - UUID format and duplicates
   - Invoice week is within active period (last 3 weeks)
   - Required fields and data types

## Known Patterns

### Preventing Extraction Loops
The `useInvoiceExtraction` hook uses a ref (`extractionAttemptedRef`) to track file pairs that have already been processed, preventing infinite loops when validation fails but files remain in state.

### File Processing Flow
1. User uploads XML + PDF
2. Frontend validates filenames match
3. Frontend extracts UUID from XML (quick check)
4. Frontend calls `/api/validate` to check for duplicates
5. Frontend calls `/api/extract` for AI extraction
6. User reviews and confirms data
7. Frontend calls `/api/invoice` to save
